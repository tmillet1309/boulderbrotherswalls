<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Boulder Brothers â€“ Wall Designer</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet" />
<style>
  :root{
    --orange:#FF6600;
    --green:#145A32;
    --card:#ffffffcc;
    --stud:#567a6355;
    --panel-outline:#1c3b31a8;
    --panel-fill:#d5b38a;         /* warm wood tone */
    --holes:#2d4b3fcc;            /* T-nut holes */
    --nest-bg:#e8efe9aa;
    --nest-stroke:#27493d40;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:#102018;
    background:linear-gradient(135deg,#d8e0d5 0%,#c7d2c7 25%,#b1c1ae 50%,#f0a56a 75%,#ea8f49 100%);
    overflow-x:hidden;
  }

  .wrap{
    min-height:100%;
    display:grid;
    grid-template-columns: 340px 1fr;
    grid-template-rows: auto 1fr auto;
  }

  header{
    grid-column:1 / -1;
    display:grid;
    grid-template-columns: 220px 1fr 220px;
    align-items:center;
    padding:12px 16px 4px;
  }
  header img{height:198px;width:auto}
  header h1{
    margin:0;text-align:center;font-weight:900;letter-spacing:.01em;
    font-size:3.2rem;color:#0f2f24;text-shadow:0 2px 0 #ffffff70;
  }

  .side{
    width: 324px;background:var(--card);backdrop-filter: blur(3px);
    margin:0 0 16px 16px;padding:16px;border-radius:14px;border:1px solid #00000014;
    align-self:start;max-height: calc(100vh - 230px);overflow-y:auto;overflow-x:hidden;
  }
  .sec{margin:6px 0 16px}
  .sec h2{margin:0 0 10px;font-size:1rem;color:#1f4637}
  .grid2{display:grid;grid-template-columns:1fr 1fr; gap:10px}
  .field{display:flex;flex-direction:column;gap:6px; min-width:0}
  label{font-size:.8rem;color:#2a5443}
  input,button{font:inherit;padding:10px 12px;border-radius:12px;min-width:0}
  input{border:1px solid #00000022;background:#fff;outline:none}
  input:focus{border-color:#2a6b56}
  .btn{background:var(--orange);color:#fff;border:none;font-weight:800;cursor:pointer}
  .btn.secondary{background:#fff;color:#1c3d32;border:1px solid #00000020}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .metrics{margin-top:10px;padding:12px;border-radius:12px;background:#f7faf8;border:1px solid #00000012;font-size:.95rem;line-height:1.3}
  .palette{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .swatch{padding:10px;border:1px solid #00000020;border-radius:12px;background:#fff;cursor:pointer}

  .canvas-wrap{display:grid;align-items:center;justify-items:center;padding:10px 20px 20px 10px;background:transparent}
  svg#board{width:100%;height:100%;max-height:calc(100vh - 60px)}

  .prop-panel{display:none;margin-top:10px;gap:10px}
  .prop-panel.show{display:grid}
  .prop-panel input[type=range]{width:100%}

  footer{grid-column:1 / -1;text-align:center;color:#e6efe9;padding:10px 0 18px;font-weight:800}

  @media (max-width:1150px){
    .wrap{grid-template-columns:1fr;grid-template-rows:auto auto 1fr auto}
    .side{margin:0 16px 16px;max-height:none;width:auto}
    svg#board{max-height:70vh}
    header{grid-template-columns:160px 1fr 80px}
    header img{height:160px}
    header h1{font-size:2.4rem}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="logo.png" alt="Boulder Brothers Logo" />
      <h1>Wall Designer</h1>
      <div></div>
    </header>

    <aside class="side">
      <div class="sec">
        <h2>Wall Size</h2>
        <div class="grid2">
          <div class="field"><label>Width (ft)</label><input type="number" id="wFt" value="10" min="1"></div>
          <div class="field"><label>Width (in)</label><input type="number" id="wIn" value="0" min="0" max="11"></div>
          <div class="field"><label>Height (ft)</label><input type="number" id="hFt" value="10" min="1"></div>
          <div class="field"><label>Height (in)</label><input type="number" id="hIn" value="0" min="0" max="11"></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="apply">Apply Size</button>
          <button class="btn secondary" id="resetHolds">Clear Holds</button>
        </div>
        <div class="metrics" id="metrics">â€”</div>
      </div>

      <div class="sec">
        <h2>Panel Nest</h2>
        <div class="row">
          <button class="btn secondary" id="addPanel">Add 48Ã—48</button>
          <button class="btn secondary" id="clearLoose">Clear Loose</button>
        </div>
        <small style="display:block;margin-top:6px;color:#2a5443">Drag panels out of the nest onto the wall. They clip visually at edges.</small>
      </div>

      <div class="sec">
        <h2>Add Holds</h2>
        <div class="palette">
          <button class="swatch" data-shape="jug">ðŸŸ£ Jug</button>
          <button class="swatch" data-shape="crimp">ðŸ”µ Crimp</button>
          <button class="swatch" data-shape="sloper">ðŸŸ¢ Sloper</button>
          <button class="swatch" data-shape="volume">ðŸŸ§ Volume</button>
        </div>
        <div class="row" style="margin-top:10px">
          <label style="font-size:.85rem;color:#2a5443;">Color</label>
          <input type="color" id="color" value="#FF6600">
          <button class="btn secondary" id="save">Save</button>
          <button class="btn secondary" id="load">Load</button>
          <button class="btn secondary" id="export">Export PNG</button>
        </div>
        <div id="propPanel" class="prop-panel">
          <label>Size <input type="range" id="size" min="12" max="120" value="48"></label>
          <label>Rotation <input type="range" id="rot" min="0" max="359" value="0"></label>
          <button id="delete" class="btn secondary">Delete Selected</button>
        </div>
      </div>
    </aside>

    <section class="canvas-wrap">
      <svg id="board" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet"></svg>
    </section>

    <footer>Build together. Climb together.</footer>
  </div>

<script>
(() => {
  const board = document.getElementById('board');
  const metricsEl = document.getElementById('metrics');
  const colorEl = document.getElementById('color');

  // hidden pricing
  const PANEL_PRICE = 100;
  const CUT_PCT     = 0.10;

  // panel & hole geometry
  const PANEL_SIZE      = 48; // inches
  const HOLE_SPACING    = 8;  // inches
  const HOLE_INSET      = 4;  // inches
  const HOLE_RADIUS_IN  = 0.6;
  const SNAP_THRESHOLD  = 6;  // inches

  // NEST (inventory) area width in inches
  const NEST_W = 72; // ~6 ft tray on left

  const inputs = {
    wFt: document.getElementById('wFt'),
    wIn: document.getElementById('wIn'),
    hFt: document.getElementById('hFt'),
    hIn: document.getElementById('hIn'),
  };

  // sidebar controls
  const applyBtn  = document.getElementById('apply');
  const clearBtn  = document.getElementById('resetHolds');
  const saveBtn   = document.getElementById('save');
  const loadBtn   = document.getElementById('load');
  const exportBtn = document.getElementById('export');
  const addPanelBtn = document.getElementById('addPanel');
  const clearLooseBtn = document.getElementById('clearLoose');

  const propPanel = document.getElementById('propPanel');
  const sizeRange = document.getElementById('size');
  const rotRange  = document.getElementById('rot');
  const delBtn    = document.getElementById('delete');

  let wall = { wInch: 120, hInch: 120 };
  let bgLayer, wallGroup, panelsLayer, holesLayer, holdsLayer, looseLayer, nestLayer, defs;
  let patternId;
  let selected = null;
  let holePoints = [];  // global bolt coords
  let offsetX = NEST_W; // wall x-offset to make room for nest

  const ceil   = Math.ceil;
  const clamp  = (v,min,max)=> Math.max(min, Math.min(max, v));
  const inches = (ft, inch) => (Number(ft)||0)*12 + (Number(inch)||0);

  function computePanels(w,h){
    const cols = ceil(w/PANEL_SIZE);
    const rows = ceil(h/PANEL_SIZE);
    const base = cols * rows;

    const wR = (w % PANEL_SIZE) !== 0;
    const hR = (h % PANEL_SIZE) !== 0;
    let cutPanels = 0;
    if (wR) cutPanels += rows;
    if (hR) cutPanels += cols;
    if (wR && hR) cutPanels -= 1;

    const material = base * PANEL_PRICE;
    const cutting  = cutPanels * PANEL_PRICE * CUT_PCT;
    const total    = material + cutting;

    return { cols, rows, base, total, wR, hR, cutPanels };
  }

  function initSvg(){
    while(board.firstChild) board.removeChild(board.firstChild);
    defs = svg('defs');

    // cube pattern
    patternId = 'cubePattern';
    const pattern = svg('pattern',{id:patternId,patternUnits:'userSpaceOnUse',width:24,height:24});
    pattern.appendChild(svg('path',{d:'M0 12 L12 0 L24 12 L12 24 Z', fill:'none', stroke:'#325c4a22','stroke-width':1}));
    defs.appendChild(pattern);

    // clipping path for wall
    const clip = svg('clipPath',{id:'wallClip'});
    clip.appendChild(svg('rect',{id:'clipRect',x:offsetX,y:0,width:wall.wInch,height:wall.hInch,rx:2,ry:2}));
    defs.appendChild(clip);

    board.appendChild(defs);

    // layers
    bgLayer    = svg('g',{id:'bg'});                 board.appendChild(bgLayer);
    nestLayer  = svg('g',{id:'nest'});               board.appendChild(nestLayer);
    wallGroup  = svg('g',{id:'wallGroup'});          board.appendChild(wallGroup);
    panelsLayer= svg('g',{id:'panels', 'clip-path':'url(#wallClip)'}); wallGroup.appendChild(panelsLayer);
    holesLayer = svg('g',{id:'holes',  'clip-path':'url(#wallClip)'}); wallGroup.appendChild(holesLayer);
    holdsLayer = svg('g',{id:'holds'});              board.appendChild(holdsLayer);
    looseLayer = svg('g',{id:'loose'});              board.appendChild(looseLayer);
  }

  function draw(){
    initSvg();

    const { wInch, hInch } = wall;
    // expand viewBox to include nest + wall + small pad
    const pad = 0.05, totalW = offsetX + wInch, totalH = hInch;
    board.setAttribute('viewBox', `${-totalW*pad} ${-totalH*pad} ${totalW*(1+2*pad)} ${totalH*(1+2*pad)}`);

    // --- Nest ---
    drawNest();

    // subtle cube pattern behind wall area only
    bgLayer.appendChild(svg('rect',{x:offsetX,y:0,width:wInch,height:hInch,fill:`url(#${patternId})`,rx:2,ry:2}));
    // studs 16" OC
    for(let x=offsetX+16; x<offsetX+wInch; x+=16)
      bgLayer.appendChild(svg('line',{x1:x,y1:0,x2:x,y2:hInch,stroke:'var(--stud)','stroke-width':1}));
    // wall outline
    bgLayer.appendChild(svg('rect',{x:offsetX,y:0,width:wInch,height:hInch,fill:'none',stroke:'#0c2b2180','stroke-width':3,rx:2,ry:2}));

    buildWallTilesAndHoles();
    preloadNestPanels(); // only if empty
    updateMetrics();
  }

  function drawNest(){
    nestLayer.replaceChildren();
    const { hInch } = wall;
    // tray background
    nestLayer.appendChild(svg('rect',{x:4,y:4,width:offsetX-8,height:hInch-8,rx:10,ry:10,fill:'var(--nest-bg)',stroke:'var(--nest-stroke)','stroke-width':2}));
    // label
    nestLayer.appendChild(svg('text',{x:12,y:26, 'font-size':12, fill:'#27493d', 'font-weight':800}, 'NEST'));
  }

  function buildWallTilesAndHoles(){
    panelsLayer.replaceChildren();
    holesLayer.replaceChildren();
    holePoints = [];

    const { wInch, hInch } = wall;
    const cols = Math.ceil(wInch/PANEL_SIZE);
    const rows = Math.ceil(hInch/PANEL_SIZE);
    const lastW = (wInch % PANEL_SIZE) || PANEL_SIZE;
    const lastH = (hInch % PANEL_SIZE) || PANEL_SIZE;

    for(let c=0;c<cols;c++){
      for(let r=0;r<rows;r++){
        const x = offsetX + c*PANEL_SIZE, y = r*PANEL_SIZE;
        const w = (c===cols-1)? lastW : PANEL_SIZE;
        const h = (r===rows-1)? lastH : PANEL_SIZE;

        // tile fill
        ensureWoodGradient(w,h);
        const rect = svg('rect',{x, y, width:w, height:h, rx:2, ry:2,
          fill:`url(#wood-${w}x${h})`, stroke:'var(--panel-outline)', 'stroke-width':2});
        panelsLayer.appendChild(rect);

        // bolt holes (global coords)
        const hx0 = x + HOLE_INSET;
        const hy0 = y + HOLE_INSET;
        for(let hx=hx0; hx<=x+w-HOLE_INSET+0.1; hx+=HOLE_SPACING){
          for(let hy=hy0; hy<=y+h-HOLE_INSET+0.1; hy+=HOLE_SPACING){
            holePoints.push({x:hx,y:hy});
            holesLayer.appendChild(svg('circle',{cx:hx,cy:hy,r:HOLE_RADIUS_IN,fill:'none',stroke:'var(--holes)','stroke-width':1}));
          }
        }
      }
    }
  }

  function preloadNestPanels(){
    if (looseLayer.childNodes.length) return;
    // make a tidy stack of 6 in the nest
    const gap = 6, startX = 16, startY = 40;
    for(let i=0;i<6;i++){
      spawnLoosePanel(PANEL_SIZE, PANEL_SIZE, startX, startY + i*(PANEL_SIZE/2 + gap));
    }
  }

  function spawnLoosePanel(w,h,x,y){
    ensureWoodGradient(w,h);
    const g = svg('g',{class:'loose-panel', transform:`translate(${x} ${y})`,'data-w':w,'data-h':h, 'clip-path':'url(#wallClip)'});
    const r = svg('rect',{x:0,y:0,width:w,height:h,rx:2,ry:2, fill:`url(#wood-${w}x${h})`, stroke:'var(--panel-outline)','stroke-width':2});
    g.appendChild(r);
    looseLayer.appendChild(g);
    makePanelDraggable(g,true); // true => from nest/inventory
  }

  // wood gradient per unique size
  function ensureWoodGradient(w,h){
    const id = `wood-${w}x${h}`;
    if (document.getElementById(id)) return;
    const lg = svg('linearGradient',{id, x1:'0%',y1:'0%',x2:'0%',y2:'100%'});
    lg.appendChild(svg('stop',{offset:'0%','stop-color':shade(getVar('--panel-fill'),1.08)}));
    lg.appendChild(svg('stop',{offset:'100%','stop-color':shade(getVar('--panel-fill'),0.92)}));
    defs.appendChild(lg);
  }

  function updateMetrics(){
    const { wInch, hInch } = wall;
    const p = computePanels(wInch,hInch);
    const ftin = v => `${Math.floor(v/12)}â€™ ${v%12}"`;
    metricsEl.innerHTML = `
      <div><strong>Wall:</strong> ${ftin(wInch)} Ã— ${ftin(hInch)}</div>
      <div>Panels: <strong>${p.cols}</strong> across Ã— <strong>${p.rows}</strong> down &nbsp;(<strong>${p.base}</strong> total)</div>
      <div style="margin-top:6px;border-top:1px dashed #0001;padding-top:6px">
        <strong>Estimated total:</strong> $${p.total.toFixed(2)}
      </div>
    `;
  }

  /* Holds (same behavior; snap to nearest bolt on mouseup) */
  const defaultSizes = {jug:56, crimp:36, sloper:48, volume:80};
  function addHold(shape, color, x, y){
    const g = svg('g',{class:'hold',transform:`translate(${x||offsetX + wall.wInch/2} ${y||wall.hInch/2}) rotate(0)`,
      'data-shape':shape,'data-size':defaultSizes[shape]||48,'data-rot':0,'data-color':color});
    const size = Number(g.getAttribute('data-size'));
    g.appendChild(shapeNode(shape,size,color));
    holdsLayer.appendChild(g);
    makeHoldDraggable(g);
    select(g);
  }
  function shapeNode(shape, size, color){
    const ng = svg('g');
    if(shape==='jug'){
      ng.appendChild(svg('circle',{cx:0,cy:0,r:size/2,fill:color,stroke:'#00000030','stroke-width':1.5}));
      ng.appendChild(svg('circle',{cx:-size*0.12,cy:-size*0.05,r:size*0.12,fill:'#ffffff66'}));
    } else if(shape==='crimp'){
      const w=size,h=size*0.45;
      ng.appendChild(svg('rect',{x:-w/2,y:-h/2,width:w,height:h,rx:h*0.4,ry:h*0.4,fill:color,stroke:'#00000030','stroke-width':1.5}));
    } else if(shape==='sloper'){
      ng.appendChild(svg('ellipse',{cx:0,cy:0,rx:size*0.58,ry:size*0.40,fill:color,stroke:'#00000030','stroke-width':1.5}));
    } else { const s=size; ng.appendChild(svg('path',{d:`M ${-s/2} ${s/2} L 0 ${-s/2} L ${s/2} ${s/2} Z`,fill:color,stroke:'#00000030','stroke-width':1.5})); }
    return ng;
  }
  function makeHoldDraggable(g){
    let dragging=false, offset=null;
    g.addEventListener('pointerdown',(e)=>{select(g);dragging=true;const pt=svgPoint(e);const m=g.getCTM();offset={x:pt.x-m.e,y:pt.y-m.f};g.setPointerCapture(e.pointerId);});
    g.addEventListener('pointermove',(e)=>{if(!dragging)return;const pt=svgPoint(e);const x=pt.x-offset.x;const y=pt.y-offset.y;const rot=Number(g.getAttribute('data-rot'))||0;g.setAttribute('transform',`translate(${x} ${y}) rotate(${rot})`);});
    g.addEventListener('pointerup',()=>{dragging=false; snapHoldToNearestBolt(g);});
    g.addEventListener('wheel',(e)=>{if(selected!==g)return;e.preventDefault();const delta=(e.deltaY<0?4:-4);const ns=clamp(Number(g.getAttribute('data-size'))+delta,12,140);g.setAttribute('data-size',ns);g.replaceChildren(shapeNode(g.getAttribute('data-shape'),ns,g.getAttribute('data-color')));sizeRange.value=ns;},{passive:false});
    g.addEventListener('dblclick',()=>{g.remove();if(selected===g)select(null);});
  }
  function snapHoldToNearestBolt(g){
    if(!holePoints.length) return;
    const m = g.getCTM();
    let best = null, bestD = Infinity;
    for(const p of holePoints){
      const dx = p.x - m.e, dy = p.y - m.f, d = Math.hypot(dx,dy);
      if (d < bestD){ bestD = d; best = p; }
    }
    if(best && bestD <= SNAP_THRESHOLD){
      const rot = Number(g.getAttribute('data-rot'))||0;
      g.setAttribute('transform', `translate(${best.x} ${best.y}) rotate(${rot})`);
    }
  }

  /* Panels â€“ now draggable ALWAYS (left-click), including from the nest) */
  function makePanelDraggable(g, isLoose=false){
    let dragging=false, offset=null;
    g.style.cursor='grab';
    g.addEventListener('pointerdown',(e)=>{
      dragging=true;const pt=svgPoint(e);const m=g.getCTM();
      offset={x:pt.x-m.e,y:pt.y-m.f};g.setPointerCapture(e.pointerId);g.style.cursor='grabbing';
    });
    g.addEventListener('pointermove',(e)=>{
      if(!dragging)return;
      const pt=svgPoint(e);
      const x=pt.x-offset.x, y=pt.y-offset.y;
      g.setAttribute('transform',`translate(${x} ${y})`);
    });
    g.addEventListener('pointerup',()=>{dragging=false;g.style.cursor='grab';});
  }

  // Sidebar actions
  document.querySelectorAll('.swatch').forEach(b=>b.addEventListener('click',()=>addHold(b.dataset.shape,colorEl.value)));

  addPanelBtn.addEventListener('click',()=>{
    // place a new panel near top of nest
    spawnLoosePanel(PANEL_SIZE,PANEL_SIZE, 16, 40);
  });
  clearLooseBtn.addEventListener('click',()=>{looseLayer.replaceChildren();});

  applyBtn.addEventListener('click',()=>{
    wall.wInch=inches(inputs.wFt.value,inputs.wIn.value);
    wall.hInch=inches(inputs.hFt.value,inputs.hIn.value);
    // update clip rect and redraw
    draw();
  });

  clearBtn.addEventListener('click',()=>{holdsLayer.replaceChildren();select(null);});

  saveBtn.addEventListener('click',()=>{
    const data={
      wall,
      holds:[...holdsLayer.querySelectorAll('.hold')].map(h=>({
        shape:h.getAttribute('data-shape'),size:+h.getAttribute('data-size'),
        rot:+h.getAttribute('data-rot'),color:h.getAttribute('data-color'),
        x:h.getCTM().e,y:h.getCTM().f
      })),
      loose:[...looseLayer.querySelectorAll('.loose-panel')].map(p=>({
        w:+p.getAttribute('data-w'),h:+p.getAttribute('data-h'),
        x:p.getCTM().e,y:p.getCTM().f
      }))
    };
    localStorage.setItem('bb-wall-designer-v2',JSON.stringify(data));
  });

  loadBtn.addEventListener('click',()=>{
    const raw=localStorage.getItem('bb-wall-designer-v2'); if(!raw) return;
    const d=JSON.parse(raw);
    wall=d.wall;
    inputs.wFt.value=Math.floor(wall.wInch/12);
    inputs.wIn.value=wall.wInch%12;
    inputs.hFt.value=Math.floor(wall.hInch/12);
    inputs.hIn.value=wall.hInch%12;
    draw();
    // holds
    holdsLayer.replaceChildren();
    (d.holds||[]).forEach(h=>{
      const g=svg('g',{class:'hold',transform:`translate(${h.x} ${h.y}) rotate(${h.rot})`,
        'data-shape':h.shape,'data-size':h.size,'data-rot':h.rot,'data-color':h.color});
      g.appendChild(shapeNode(h.shape,h.size,h.color)); holdsLayer.appendChild(g); makeHoldDraggable(g);
    });
    // loose
    looseLayer.replaceChildren();
    (d.loose||[]).forEach(p=> spawnLoosePanel(p.w,p.h,p.x,p.y));
    select(null);
  });

  exportBtn.addEventListener('click',()=>{
    const xml=new XMLSerializer().serializeToString(board);
    const url='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(xml);
    const img=new Image();
    img.onload=function(){
      const c=document.createElement('canvas'); c.width=img.width*2; c.height=img.height*2;
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,c.width,c.height);
      const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='boulder-brothers-wall.png'; a.click();
    };
    img.src=url;
  });

  // Utils
  function svg(tag,attrs={},text){
    const el=document.createElementNS('http://www.w3.org/2000/svg',tag);
    for(const[k,v] of Object.entries(attrs)) el.setAttribute(k,v);
    if(text) el.textContent=text;
    return el;
  }
  function svgPoint(evt){const pt=board.createSVGPoint();pt.x=evt.clientX;pt.y=evt.clientY;return pt.matrixTransform(board.getScreenCTM().inverse());}
  function getVar(name){return getComputedStyle(document.documentElement).getPropertyValue(name).trim();}
  function shade(hex,f){const n=parseInt(hex.slice(1),16), r=n>>16, g=n>>8&255, b=n&255;const rr=Math.min(255,Math.max(0,Math.round(r*f)));const gg=Math.min(255,Math.max(0,Math.round(g*f)));const bb=Math.min(255,Math.max(0,Math.round(b*f)));return '#'+[rr,gg,bb].map(x=>x.toString(16).padStart(2,'0')).join('');}

  // Init
  draw();

  // keyboard delete for selected hold
  window.addEventListener('keydown',(e)=>{if((e.key==='Delete'||e.key==='Backspace')&&selected){selected.remove();select(null);}});

  function select(g){
    selected=g;
    if(!g || !g.classList.contains('hold')){propPanel.classList.remove('show');return;}
    propPanel.classList.add('show');
    sizeRange.value=g.getAttribute('data-size');
    rotRange.value=g.getAttribute('data-rot');
    document.getElementById('color').value = '#FF6600';
  }
  rotRange.addEventListener('input',()=>{if(!selected)return;const rot=+rotRange.value;selected.setAttribute('data-rot',rot);const m=selected.getCTM();selected.setAttribute('transform',`translate(${m.e} ${m.f}) rotate(${rot})`);});
  sizeRange.addEventListener('input',()=>{if(!selected)return;const s=+sizeRange.value;selected.setAttribute('data-size',s);selected.replaceChildren(shapeNode(selected.getAttribute('data-shape'),s,selected.getAttribute('data-color')));});
  delBtn.addEventListener('click',()=>{if(selected){selected.remove();select(null);}});
})();
</script>
</body>
</html>
