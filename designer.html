<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Boulder Brothers ‚Äì Wall Designer</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet" />
<style>
  :root{
    --orange:#FF6600;
    --green:#145A32;
    --sage:#d8e0d5;
    --ink:#0f1f14;
    --grid:#9bb49f40;           /* light sage grid */
    --stud:#567a6355;
    --panel:#2d4b3f66;
    --card:#ffffffcc;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family:'Montserrat',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:#102018;
    background:
      linear-gradient(135deg,#d8e0d5 0%,#c7d2c7 25%,#b1c1ae 50%,#f0a56a 75%,#ea8f49 100%);
  }

  .wrap{
    display:grid;
    grid-template-columns: 340px 1fr;
    grid-template-rows: auto 1fr auto;
    min-height:100%;
    gap:0;
  }

  header{
    grid-column:1 / -1;
    padding:12px 18px 0;
    display:flex;
    align-items:flex-start;
    gap:14px;
  }
  header .brand{display:flex;gap:12px;align-items:flex-start}
  header img{height:198px;width:auto; border-radius:8px;} /* 90% of 220px */
  header h1{font-size:1.15rem;margin:8px 0 0;font-weight:900;letter-spacing:.02em;color:#143627}

  .side{
    background:var(--card);
    backdrop-filter: blur(3px);
    margin:0 0 16px 16px;
    padding:16px;
    border-radius:14px;
    border:1px solid #00000014;
    align-self:start;

    /* keep everything inside the card; scroll if needed */
    max-height: calc(100vh - 230px);
    overflow:auto;
  }

  .side h2{margin:.2rem 0 .8rem;font-size:1.05rem}
  .grid2{display:grid;grid-template-columns:1fr 1fr; gap:10px}
  label{font-size:.8rem;color:#2a5443}
  .field{display:flex;flex-direction:column;gap:6px}
  input,select,button{
    font:inherit;
    padding:9px 10px;
    border-radius:10px;
    border:1px solid #00000022;
    background:#fff;
    outline:none;
  }
  input:focus,select:focus{border-color:#2a6b56}
  .btn{background:var(--orange); color:#fff; border:none; font-weight:800; cursor:pointer}
  .btn.secondary{background:#fff; color:#1c3d32; border:1px solid #00000020}
  .btn.ghost{background:transparent; border:1px dashed #00000030; color:#214236}
  .stack{display:flex;flex-direction:column;gap:10px}
  .row{display:flex;gap:10px; align-items:center; flex-wrap:wrap}

  .metrics{
    margin-top:10px;
    padding:10px;
    border-radius:12px;
    background:#f7faf8;
    border:1px solid #00000010;
    font-size:.92rem;
  }

  .palette{
    display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:6px;
  }
  .swatch{
    aspect-ratio:1/1; display:grid; place-items:center; border-radius:10px; cursor:pointer;
    border:1px solid #00000020; background:#fff;
  }
  .swatch span{font-size:.75rem}

  .canvas-wrap{
    position:relative; overflow:hidden;
    display:grid; align-items:center; justify-items:center; padding:10px 20px 20px 10px;
  }

  /* Board area */
  svg#board{width:100%; height:100%; max-height:calc(100vh - 60px); background:transparent}

  .toolbar{margin-top:12px; border-top:1px solid #00000012; padding-top:12px;}

  .prop-panel{
    margin-top:12px; padding:10px; border:1px solid #00000010; border-radius:12px; background:#fafcfb;
    display:none; gap:8px;
  }
  .prop-panel.show{display:grid}
  .prop-panel label{font-size:.75rem}
  .prop-panel input[type=range]{width:100%}

  footer{grid-column:1 / -1; color:#dfe8e2; justify-content:center; font-weight:700; padding:8px 0 16px; text-align:center}
  .link-btn{position:absolute; right:20px; top:16px; background:var(--orange); color:#fff; padding:10px 14px; border-radius:10px; font-weight:800; text-decoration:none}

  @media (max-width:1120px){
    .wrap{grid-template-columns: 1fr; grid-template-rows:auto auto 1fr auto}
    header{padding-left:16px}
    .side{margin:0 16px 16px; max-height: none;}
    svg#board{max-height:70vh}
  }
</style>
</head>
<body>
  <a class="link-btn" href="./index.html">‚Üê Back to Landing</a>
  <div class="wrap">
    <header>
      <div class="brand">
        <img src="logo.png" alt="Boulder Brothers Logo" />
        <h1>Wall Designer</h1>
      </div>
    </header>

    <!-- Controls -->
    <aside class="side">
      <h2>Wall Size</h2>
      <div class="grid2">
        <div class="field">
          <label>Width (ft)</label>
          <input type="number" id="wFt" value="12" min="1">
        </div>
        <div class="field">
          <label>Width (in)</label>
          <input type="number" id="wIn" value="0" min="0" max="11">
        </div>
        <div class="field">
          <label>Height (ft)</label>
          <input type="number" id="hFt" value="8" min="1">
        </div>
        <div class="field">
          <label>Height (in)</label>
          <input type="number" id="hIn" value="0" min="0" max="11">
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="apply">Apply Size</button>
        <button class="btn secondary" id="resetHolds">Clear Holds</button>
      </div>

      <div class="metrics" id="metrics">‚Äî</div>

      <div class="toolbar">
        <h2>Panels & Cost</h2>
        <div class="grid2">
          <div class="field">
            <label>Panel cost (per 48√ó48)</label>
            <input type="number" id="panelCost" value="100" min="0" step="1">
          </div>
          <div class="field">
            <label>Cutting surcharge %</label>
            <input type="number" id="cutPct" value="10" min="0" step="1">
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <label><input type="checkbox" id="panelMode"> Enable panel drag</label>
          <button class="btn ghost" id="resetPanels">Reset Panels</button>
        </div>

        <h2 style="margin-top:14px">Add Holds</h2>
        <div class="palette">
          <button class="swatch" data-shape="jug" title="Jug"><span>üü£ Jug</span></button>
          <button class="swatch" data-shape="crimp" title="Crimp"><span>üîµ Crimp</span></button>
          <button class="swatch" data-shape="sloper" title="Sloper"><span>üü¢ Sloper</span></button>
          <button class="swatch" data-shape="volume" title="Volume"><span>üüß Vol</span></button>
        </div>

        <div class="row" style="margin-top:10px">
          <label>Color</label>
          <input type="color" id="color" value="#FF6600">
          <button class="btn ghost" id="save">Save Layout</button>
          <button class="btn ghost" id="load">Load</button>
          <button class="btn ghost" id="export">Export PNG</button>
        </div>

        <div id="propPanel" class="prop-panel">
          <div class="field">
            <label>Size</label>
            <input type="range" id="size" min="12" max="120" value="48">
          </div>
          <div class="field">
            <label>Rotation</label>
            <input type="range" id="rot" min="0" max="359" value="0">
          </div>
          <button id="delete" class="btn secondary">Delete Selected</button>
        </div>
      </div>
    </aside>

    <!-- Canvas -->
    <section class="canvas-wrap">
      <svg id="board" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet"></svg>
    </section>

    <footer>Build together. Climb together.</footer>
  </div>

<script>
(() => {
  const board = document.getElementById('board');
  const metricsEl = document.getElementById('metrics');
  const colorEl = document.getElementById('color');

  const inputs = {
    wFt: document.getElementById('wFt'),
    wIn: document.getElementById('wIn'),
    hFt: document.getElementById('hFt'),
    hIn: document.getElementById('hIn'),
    panelCost: document.getElementById('panelCost'),
    cutPct: document.getElementById('cutPct')
  };

  const applyBtn = document.getElementById('apply');
  const clearBtn = document.getElementById('resetHolds');
  const saveBtn  = document.getElementById('save');
  const loadBtn  = document.getElementById('load');
  const exportBtn= document.getElementById('export');

  const panelMode = document.getElementById('panelMode');
  const resetPanelsBtn = document.getElementById('resetPanels');

  const propPanel = document.getElementById('propPanel');
  const sizeRange = document.getElementById('size');
  const rotRange  = document.getElementById('rot');
  const delBtn    = document.getElementById('delete');

  let wall = { wInch: 144, hInch: 96 };
  let holdsLayer, gridLayer, panelsLayer, patternId;
  let selected = null, draggingHold = false;

  // helpers
  const inches = (ft, inch) => (Number(ft)||0)*12 + (Number(inch)||0);
  const ceil = Math.ceil;
  const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));

  function computePanels(w,h){
    const cols = ceil(w/48);
    const rows = ceil(h/48);
    const base = cols * rows;

    const wR = (w % 48) !== 0;  // right column is cut?
    const hR = (h % 48) !== 0;  // bottom row is cut?
    let cutPanels = 0;
    if (wR) cutPanels += rows;          // every row has a cut on the right
    if (hR) cutPanels += cols;          // every column has a cut on the bottom
    if (wR && hR) cutPanels -= 1;       // bottom-right corner counted twice

    // cost
    const cost = Number(inputs.panelCost.value)||0;
    const pct  = (Number(inputs.cutPct.value)||0) / 100;
    const material = base * cost;
    const cutting  = cutPanels * cost * pct;
    const total    = material + cutting;

    return { cols, rows, base, cutPanels, material, cutting, total };
  }

  function initSvgDefs(){
    while(board.firstChild) board.removeChild(board.firstChild);

    const defs = svg('defs');

    // Transparent "cube" pattern
    patternId = 'cubePattern';
    const pattern = svg('pattern',{id:patternId,patternUnits:'userSpaceOnUse',width:24,height:24});
    pattern.appendChild(svg('path',{d:'M0 12 L12 0 L24 12 L12 24 Z', fill:'none', stroke:'#325c4a22', 'stroke-width':1}));
    defs.appendChild(pattern);

    // Clip path for wall bounds (so panels "cut" at edges)
    const clip = svg('clipPath',{id:'wallClip'});
    clip.appendChild(svg('rect',{id:'clipRect',x:0,y:0,width:wall.wInch,height:wall.hInch,rx:2,ry:2}));
    defs.appendChild(clip);

    board.appendChild(defs);

    gridLayer   = svg('g',{id:'grid'});
    panelsLayer = svg('g',{id:'panels','clip-path':'url(#wallClip)'});
    holdsLayer  = svg('g',{id:'holds'});

    board.appendChild(gridLayer);
    board.appendChild(panelsLayer);
    board.appendChild(holdsLayer);
  }

  function drawWall(){
    initSvgDefs();

    const { wInch, hInch } = wall;

    // viewBox with small padding
    const pad = 0.05;
    board.setAttribute('viewBox', `${-wInch*pad} ${-hInch*pad} ${wInch*(1+2*pad)} ${hInch*(1+2*pad)}`);

    // Background rect with cubes
    gridLayer.appendChild(svg('rect',{
      x:0,y:0,width:wInch,height:hInch, fill:`url(#${patternId})`, rx:2, ry:2
    }));

    // Studs 16"
    for(let x=16; x<wInch; x+=16){
      gridLayer.appendChild(svg('line',{x1:x,y1:0,x2:x,y2:hInch, stroke:'var(--stud)', 'stroke-width':1}));
    }
    // Panel grid 48"
    for(let x=48; x<wInch; x+=48){
      gridLayer.appendChild(svg('line',{x1:x,y1:0,x2:x,y2:hInch, stroke:'var(--panel)', 'stroke-width':2}));
    }
    for(let y=48; y<hInch; y+=48){
      gridLayer.appendChild(svg('line',{x1:0,y1:y,x2:wInch,y2:y, stroke:'var(--panel)', 'stroke-width':2}));
    }

    // Wall outline
    gridLayer.appendChild(svg('rect',{
      x:0,y:0,width:wInch,height:hInch, fill:'none', stroke:'#0c2b2180','stroke-width':3
    }));

    // Panels (tiles)
    buildPanels();

    updateMetrics();
  }

  function buildPanels(){
    panelsLayer.replaceChildren();
    const { wInch, hInch } = wall;
    const cols = ceil(wInch/48);
    const rows = ceil(hInch/48);
    const lastW = (wInch % 48) || 48;
    const lastH = (hInch % 48) || 48;

    for(let c=0;c<cols;c++){
      for(let r=0;r<rows;r++){
        const x = c*48;
        const y = r*48;
        const w = (c===cols-1)? lastW : 48;
        const h = (r===rows-1)? lastH : 48;

        const g = svg('g',{class:'panel', transform:`translate(${x} ${y})`, 'data-w':w, 'data-h':h});
        const rect = svg('rect',{x:0,y:0,width:w,height:h, fill:'#1f3e34', opacity:0.18, stroke:'#0d241c66','stroke-width':1.5, rx:2, ry:2});
        g.appendChild(rect);

        if (panelMode.checked){
          makePanelDraggable(g);
          rect.style.cursor = 'grab';
        }
        panelsLayer.appendChild(g);
      }
    }
  }

  function updateMetrics(){
    const { wInch, hInch } = wall;
    const p = computePanels(wInch,hInch);
    const feetIn = (v)=> `${Math.floor(v/12)}‚Äô ${v%12}"`;
    metricsEl.innerHTML = `
      <div><strong>Wall:</strong> ${feetIn(wInch)} √ó ${feetIn(hInch)}</div>
      <div>Panels across: <strong>${p.cols}</strong> &nbsp; Panels down: <strong>${p.rows}</strong></div>
      <div>Total panels (48√ó48): <strong>${p.base}</strong></div>
      <div>Cut panels (subject to ${inputs.cutPct.value}% fee): <strong>${p.cutPanels}</strong></div>
      <div style="margin-top:6px;border-top:1px dashed #0001;padding-top:6px">
        Material: <strong>$${p.material.toFixed(2)}</strong> &nbsp; |
        Cutting fee: <strong>$${p.cutting.toFixed(2)}</strong> &nbsp; ‚Üí
        <strong>Total: $${p.total.toFixed(2)}</strong>
      </div>
    `;
  }

  // HOLD CREATION & INTERACTION
  const defaultSizes = {jug:56, crimp:36, sloper:48, volume:80};

  function addHold(shape, color, x, y){
    const g = svg('g',{
      class:'hold', transform:`translate(${x||wall.wInch/2} ${y||wall.hInch/2}) rotate(0)`,
      'data-shape':shape, 'data-size': defaultSizes[shape]||48, 'data-rot':0, 'data-color':color
    });

    const size = Number(g.getAttribute('data-size'));
    g.appendChild(shapeNode(shape, size, color));
    holdsLayer.appendChild(g);
    makeHoldDraggable(g);
    select(g);
  }

  function shapeNode(shape, size, color){
    const ng = svg('g');
    if(shape==='jug'){
      ng.appendChild(svg('circle',{cx:0, cy:0, r:size/2, fill:color, stroke:'#00000030','stroke-width':1.5}));
      ng.appendChild(svg('circle',{cx:-size*0.12, cy:-size*0.05, r:size*0.12, fill:'#ffffff66'}));
    } else if(shape==='crimp'){
      const w=size, h=size*0.45;
      ng.appendChild(svg('rect',{x:-w/2,y:-h/2,width:w,height:h, rx:h*0.4, ry:h*0.4, fill:color, stroke:'#00000030','stroke-width':1.5}));
    } else if(shape==='sloper'){
      ng.appendChild(svg('ellipse',{cx:0,cy:0, rx:size*0.58, ry:size*0.40, fill:color, stroke:'#00000030','stroke-width':1.5}));
    } else { // volume
      const s=size;
      const path=`M ${-s/2} ${s/2} L 0 ${-s/2} L ${s/2} ${s/2} Z`;
      ng.appendChild(svg('path',{d:path, fill:color, stroke:'#00000030','stroke-width':1.5}));
    }
    return ng;
  }

  function makeHoldDraggable(g){
    let dragging=false, offset=null;

    g.addEventListener('pointerdown', (e)=>{
      select(g);
      dragging=true;
      const pt = svgPoint(e);
      const m = g.getCTM();
      offset = { x: pt.x - m.e, y: pt.y - m.f };
      g.setPointerCapture(e.pointerId);
    });
    g.addEventListener('pointermove', (e)=>{
      if(!dragging) return;
      const pt = svgPoint(e);
      const x = clamp(pt.x - offset.x, 0, wall.wInch);
      const y = clamp(pt.y - offset.y, 0, wall.hInch);
      const rot = Number(g.getAttribute('data-rot'))||0;
      g.setAttribute('transform', `translate(${x} ${y}) rotate(${rot})`);
    });
    g.addEventListener('pointerup', ()=> dragging=false);

    // scroll wheel while dragging = resize
    g.addEventListener('wheel', (e)=>{
      if(!selected || selected!==g) return;
      e.preventDefault();
      const delta = (e.deltaY < 0 ? 4 : -4);
      const newSize = clamp(Number(g.getAttribute('data-size')) + delta, 12, 140);
      g.setAttribute('data-size', newSize);
      const color = g.getAttribute('data-color');
      const shape = g.getAttribute('data-shape');
      g.replaceChildren(shapeNode(shape,newSize,color));
      sizeRange.value = newSize;
    }, {passive:false});

    // double-click to delete
    g.addEventListener('dblclick', ()=> { g.remove(); if(selected===g) select(null); });
  }

  // PANEL DRAGGING
  function makePanelDraggable(g){
    let dragging = false, offset = null;
    g.addEventListener('pointerdown', (e)=>{
      dragging = true;
      const pt = svgPoint(e);
      const m = g.getCTM();
      offset = { x: pt.x - m.e, y: pt.y - m.f };
      g.setPointerCapture(e.pointerId);
      g.firstChild.style.cursor = 'grabbing';
    });
    g.addEventListener('pointermove', (e)=>{
      if(!dragging) return;
      const pt = svgPoint(e);
      const w = Number(g.getAttribute('data-w'));
      const h = Number(g.getAttribute('data-h'));
      const x = clamp(pt.x - offset.x, 0, wall.wInch - 1); // allow clip to do the ‚Äúcut‚Äù
      const y = clamp(pt.y - offset.y, 0, wall.hInch - 1);
      g.setAttribute('transform', `translate(${x} ${y})`);
    });
    g.addEventListener('pointerup', ()=>{
      dragging=false;
      g.firstChild.style.cursor = 'grab';
    });
  }

  function select(g){
    selected = g;
    if(!g){ propPanel.classList.remove('show'); return; }
    if(!g.classList.contains('hold')) { propPanel.classList.remove('show'); return; }
    propPanel.classList.add('show');
    sizeRange.value = g.getAttribute('data-size');
    rotRange.value  = g.getAttribute('data-rot');
    colorEl.value   = hexFromColor(g.getAttribute('data-color'));
  }

  // side controls
  sizeRange.addEventListener('input', ()=>{
    if(!selected) return;
    const size = Number(sizeRange.value);
    selected.setAttribute('data-size', size);
    const color = selected.getAttribute('data-color');
    const shape = selected.getAttribute('data-shape');
    selected.replaceChildren(shapeNode(shape,size,color));
  });
  rotRange.addEventListener('input', ()=>{
    if(!selected) return;
    const rot = Number(rotRange.value);
    selected.setAttribute('data-rot', rot);
    const m = selected.getCTM();
    selected.setAttribute('transform', `translate(${m.e} ${m.f}) rotate(${rot})`);
  });
  colorEl.addEventListener('input', ()=>{
    if(!selected) return;
    const c = colorEl.value;
    selected.setAttribute('data-color', c);
    const size = Number(selected.getAttribute('data-size'));
    const shape = selected.getAttribute('data-shape');
    selected.replaceChildren(shapeNode(shape,size,c));
  });
  delBtn.addEventListener('click', ()=>{ if(selected){ selected.remove(); select(null);} });

  document.querySelectorAll('.swatch').forEach(btn=>{
    btn.addEventListener('click', ()=> addHold(btn.dataset.shape, colorEl.value));
  });

  applyBtn.addEventListener('click', ()=>{
    wall.wInch = inches(inputs.wFt.value, inputs.wIn.value);
    wall.hInch = inches(inputs.hFt.value, inputs.hIn.value);
    drawWall();
  });

  clearBtn.addEventListener('click', ()=>{
    holdsLayer.replaceChildren();
    select(null);
  });

  panelMode.addEventListener('change', ()=> buildPanels());
  resetPanelsBtn.addEventListener('click', ()=> buildPanels());

  saveBtn.addEventListener('click', ()=>{
    const data = {
      wall,
      panelsMode: panelMode.checked,
      holds: [...holdsLayer.querySelectorAll('.hold')].map(h=>({
        shape: h.getAttribute('data-shape'),
        size:  Number(h.getAttribute('data-size')),
        rot:   Number(h.getAttribute('data-rot')),
        color: h.getAttribute('data-color'),
        x: h.getCTM().e, y: h.getCTM().f
      })),
      panelCost: inputs.panelCost.value,
      cutPct: inputs.cutPct.value
    };
    localStorage.setItem('bb-wall-designer-v1', JSON.stringify(data));
  });

  loadBtn.addEventListener('click', ()=>{
    const raw = localStorage.getItem('bb-wall-designer-v1');
    if(!raw) return;
    const data = JSON.parse(raw);
    wall = data.wall;
    inputs.wFt.value = Math.floor(wall.wInch/12);
    inputs.wIn.value = wall.wInch%12;
    inputs.hFt.value = Math.floor(wall.hInch/12);
    inputs.hIn.value = wall.hInch%12;
    inputs.panelCost.value = data.panelCost ?? inputs.panelCost.value;
    inputs.cutPct.value = data.cutPct ?? inputs.cutPct.value;
    drawWall();
    holdsLayer.replaceChildren();
    (data.holds||[]).forEach(h=>{
      const g = svg('g',{class:'hold',
        transform:`translate(${h.x} ${h.y}) rotate(${h.rot})`,
        'data-shape':h.shape, 'data-size':h.size, 'data-rot':h.rot, 'data-color':h.color
      });
      g.appendChild(shapeNode(h.shape,h.size,h.color));
      holdsLayer.appendChild(g);
      makeHoldDraggable(g);
    });
    panelMode.checked = !!data.panelsMode;
    buildPanels();
    select(null);
  });

  exportBtn.addEventListener('click', ()=>{
    const xml = new XMLSerializer().serializeToString(board);
    const svg64 = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(xml);
    const img = new Image();
    img.onload = function(){
      const c = document.createElement('canvas');
      c.width  = img.width  * 2;
      c.height = img.height * 2;
      const ctx = c.getContext('2d');
      ctx.drawImage(img, 0, 0, c.width, c.height);
      const a = document.createElement('a');
      a.href = c.toDataURL('image/png');
      a.download = 'boulder-brothers-wall.png';
      a.click();
    };
    img.src = svg64;
  });

  function svg(tag, attrs={}){
    const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
    for(const [k,v] of Object.entries(attrs)) el.setAttribute(k,v);
    return el;
  }
  function svgPoint(evt){
    const pt = board.createSVGPoint();
    pt.x = evt.clientX; pt.y = evt.clientY;
    return pt.matrixTransform(board.getScreenCTM().inverse());
  }
  function hexFromColor(c){
    if(!c) return '#FF6600';
    if(c.startsWith('#')) return c;
    const m = c.match(/(\d+),\s*(\d+),\s*(\d+)/);
    if(!m) return '#FF6600';
    const [r,g,b]=m.slice(1).map(Number);
    return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');
  }

  // init
  drawWall();

  // keyboard delete for holds
  window.addEventListener('keydown', (e)=>{
    if((e.key==='Delete'||e.key==='Backspace') && selected){
      selected.remove(); select(null);
    }
  });

})();
</script>
</body>
</html>
